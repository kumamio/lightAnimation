<!DOCTYPE html>
<html> 
<head> 
<title>index_three</title> 
<script type="text/javascript" src="jquery-1.6.4.js"></script>
<link rel="stylesheet" type="text/css" href="lightandcolor.css">
<script type="text/javascript" src="utils.js"></script>
</head>
<body > 
<canvas id="cover"></canvas>
<div class="scenes clearfix">
	<div class="scene scene_city">
		<canvas id="scene_city"></canvas>
		<canvas id="sky"></canvas>
		<div class="sun"></div>
	</div>
	<div class="scene scene_country">
		<canvas id="scene_country"></canvas>
	</div>

</div>

<script type="text/javascript">

	var clientW = window.innerWidth;
	var clientH = window.innerHeight;
	var ratioX =  clientW/2000;
	var ratioY = clientH/1000;

	var cover=document.getElementById("cover");
	var sky=document.getElementById("sky");

	$("body").css({"font-size":clientW/100+"px","width":clientW+"px","height":clientH+"px"});

	if (cover) {

		cover.width = clientW;
		cover.height = clientH;

		var ctx = cover.getContext("2d");
		ctx.moveTo(clientW/2,clientH/2);
		ctx.beginPath();
		ctx.fillStyle = '#444';
		ctx.fillRect(0,0,clientW,clientH);
		ctx.textAlign="center";

		ctx.font=clientW/4+"px Impact";
		ctx.textBaseline="middle";
		ctx.globalCompositeOperation = 'destination-out';
		ctx.shadowColor = "rgba(0,0,0,.5)";
		ctx.fillText("color",clientW/2,clientH/2);
		ctx.fillStyle = '#000';
		ctx.globalCompositeOperation = 'source-over';//amazing!

		var ctx_sky = sky.getContext("2d");
		sky.width = clientW;
		sky.height = clientH;

		var skyColor = [242,83,0];

		function playSceneCity(){
			var city=document.getElementById("scene_city");
			city.width = clientW;
			city.height = clientH;
			var ctx = city.getContext("2d");
			var skyctx = sky.getContext("2d");

			//把原先的点转化成可以生成贝塞尔曲线的点
		    var changePoint = function (arr,i,origin){
		    	if (arr.length==6) {
				    arr = arr.map(function(value, index){
				    	return value + origin[(index % 2 == 0) ? 0 : 1];
				    })
		    	}else{
		    		if(arr[6]=="C"){
					    arr.length = 6;
		    		}
		    	}
		    	origin[0] = arr[4];
		    	origin[1] = arr[5];
		    	return arr;
		    }

		    var newPointList=[];

		    //画曲线
		    var pointToCurve = function(pointlist,ctx,origin) {
		 	    Array.prototype.map.call(pointlist, function(value,index){
			    	var innerArr = value.map(function(v,i){
			    		if ( i<=5 ) {
			    			return (i % 2 == 0) ? parseInt(v*ratioX) : parseInt(v*ratioY);
			    		}else{
			    			return v;
			    		}
			    	})
			    	newPointList[index] = innerArr;
			    	var arr = changePoint(innerArr,index,origin);
		    		ctx.bezierCurveTo(arr[0], arr[1], arr[2], arr[3], arr[4], arr[5]);
			    	return innerArr;
			    })
		    }

		    var skyColor = [240,84,0];

			function drawScene() {
				light=light +1;
				
				//随着light变化生成新的hsl色值
				var newHsl = function(arr) {
					return "hsl("+arr[0]+","+arr[1]+"%,"+parseInt(light/100*arr[2])+"% )"
				}
				
				if (light<=100) {

					function drawBG(color,light){
						var h = color[0];
						var s = color[1];
						var l = light;
						var newColor = [h+1,s-1,l+1]
						console.log(color + ":"+newColor);
						var grd = skyctx.createLinearGradient(0,0,0, clientH);
						grd.addColorStop(0,   newHsl(color));
						grd.addColorStop(0.8,   newHsl(newColor));
						grd.addColorStop(1,   "#fff");
						skyctx.fillStyle = grd;
						skyctx.fillRect(0,0,clientW,clientH);
						skyColor = newColor;
					}
					
					//画矩形
					var drawRect = function(x,y,h,s,l,width,height){
						ctx.fillStyle = "hsl("+h+", "+s+"%, "+ l*light/100+ "%)";
						ctx.fillRect(x*ratioX,y*ratioY,width*ratioX,height*ratioY);
					}

					//画窗户
					var drawWindows = function(x,y,width,height){
						for (var j = 0; j < 4; j++) {
							for (var i = 0; i < 2; i++) {
								drawRect(x+width*2*i,y+height*1.5*j,56,94,50,width,height,ctx)
							};

						}
					}

					//画树枝
					var drawTree =function (ctx, x, y, w, h) {
					  var kappa = 0.5522848;
					      ox = (w / 2) * kappa, 
					      oy = (h / 2) * kappa, 
					      xe = x + w,           
					      ye = y + h,           
					      xm = x + w / 2,       
					      ym = y + h / 2;       

						var treeColor1 = newHsl([25,100,28]);
						var treeColor2 = newHsl([10,69,26]);

						var grd = ctx.createLinearGradient(x,y,x+w, y);
						grd.addColorStop(0,   treeColor1);
						grd.addColorStop(0.5, treeColor1);
						grd.addColorStop(0.5, treeColor2);
						grd.addColorStop(1,   treeColor2);
						ctx.fillStyle = grd;

						ctx.beginPath();
						ctx.moveTo(x, ym);
						ctx.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
						ctx.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
						ctx.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
						ctx.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
						ctx.closePath();
						ctx.fill();

					}

					var drawGrass = function(){

						var grassColor1 = newHsl([73,100,31]);
						var grassColor2 = newHsl([91,88,28]);

						var grd = ctx.createLinearGradient(0,clientH,clientW, clientH);
						grd.addColorStop(0,   grassColor1);
						grd.addColorStop(0.2, grassColor1);
						grd.addColorStop(0.2, grassColor2);
						grd.addColorStop(0.4, grassColor2);
						grd.addColorStop(0.4, grassColor1);
						grd.addColorStop(0.6, grassColor1);
						grd.addColorStop(0.6, grassColor2);
						grd.addColorStop(0.8, grassColor2);
						grd.addColorStop(0.8, grassColor1);
						grd.addColorStop(1,   grassColor1);
						ctx.fillStyle = grd;
						ctx.fillRect(0,0.8*clientH,clientW,clientH);	

					}




					var drawMountain = function(origin,pointlist,color){
						ctx.beginPath();
						ctx.moveTo( origin[0]*ratioX, origin[1]*ratioY);
						pointToCurve ( pointlist, ctx, origin );
						ctx.fillStyle = newHsl(color);
						ctx.fill();
						ctx.closePath();
					}

					var mountainPointList = [[-208, -0.136, -417, -0.27, -625, -0.41],[129, -49, 176, -254, 199, -373],[8, -43, 28, -114, 8.6, -157],[-15, -32, 87, -27, 108, -27],[151, -1.7, 105, 25, 113, 150],[8.8, 142, 48, 347, 198, 406]];

					var mountain2PointList = [[261, -414, 314, -284, 499, -5],[1650, 1010, 950, 949, 1027, 828, "C"]];

					var cloud1PointList = [ [-40, -23, -86, -24, -114, 17], [-6, 8.6, -16, 0.1, -26, -0.1], [-20, -0.3, -27, 15.5, -26, 33], [-24, -14, -62, 8.6, -82, 20], [58, 1.5, 117, 2, 175, 2.4], [90, 0.3, 181, 1.8, 270, -8.4], [-46, -5, -85, -23, -122, -51], [1731, 109, 1710, 98, 1681, 114, "C"] ];



					drawMountain([1998, 810], mountainPointList,[326,28,40]);//画山
					drawMountain([1027, 828], mountain2PointList,[65,70,50]);


					drawMountain([1681,114], cloud1PointList,[227,15,55]);


					drawRect(1152,740,10,97,14,22,60);//画树杆
					drawRect(1305,762,10,97,14,18,56);
					drawTree(ctx, 1101*ratioX, 568*ratioY, 124*ratioX, 198*ratioY);//画树枝
					drawTree(ctx, 1268*ratioX, 628*ratioY, 94*ratioX, 149*ratioY);

					drawRect(366,313,0,0,35,237,490);//画两栋建筑
					drawRect(705,414,0,0,35,186,386);

					drawWindows(418,365,44,70);//建筑上的窗户
					drawWindows(749,453,33,54);

					drawGrass();

					setTimeout(function(){
						requestAnimationFrame(drawScene);
					},50)
				}

			}

			drawScene();
		}




		cover.addEventListener('mousedown',function(event){
			var x = event.pageX;
			var y = event.pageY;
			var radius = 0;

			(function drawCircle() {
				radius = (radius+1)*1.15;

				ctx.beginPath();
				ctx.arc(event.pageX, event.pageY, radius, 0, 2 * Math.PI);
				ctx.fill();
				if (radius<=clientW) {
					setTimeout(function(){
						requestAnimationFrame(drawCircle);
					},10)
				}else{
					//触发第二幅动画
					playSceneCity();
					// ctx.globalCompositeOperation = 'destination-out';
					// ctx.fillRect(0,0,clientW,clientH);
				}
			})(ctx);

		},false)

	};

	var light = 0;





</script>


</body>
</html> 


